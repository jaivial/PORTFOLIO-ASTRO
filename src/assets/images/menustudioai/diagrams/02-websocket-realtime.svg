<svg viewBox="0 0 800 550" xmlns="http://www.w3.org/2000/svg">
  <defs>
    <linearGradient id="wsGrad" x1="0%" y1="0%" x2="100%" y2="0%">
      <stop offset="0%" style="stop-color:#10b981"/>
      <stop offset="100%" style="stop-color:#059669"/>
    </linearGradient>
    <filter id="shadow2" x="-20%" y="-20%" width="140%" height="140%">
      <feDropShadow dx="2" dy="2" stdDeviation="3" flood-opacity="0.15"/>
    </filter>
    <marker id="arrow" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#64748b"/>
    </marker>
    <marker id="arrowGreen" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#10b981"/>
    </marker>
  </defs>

  <rect width="800" height="550" fill="#f1f5f9"/>
  <text x="400" y="35" text-anchor="middle" font-family="system-ui" font-size="20" font-weight="bold" fill="#1e293b">WebSocket Real-time Communication</text>

  <!-- Client Devices -->
  <g filter="url(#shadow2)">
    <rect x="30" y="80" width="130" height="180" rx="10" fill="white" stroke="#e2e8f0" stroke-width="2"/>
    <rect x="30" y="80" width="130" height="35" rx="10" fill="url(#wsGrad)"/>
    <text x="95" y="103" text-anchor="middle" font-family="system-ui" font-size="12" font-weight="600" fill="white">Client Devices</text>

    <rect x="45" y="125" width="100" height="30" rx="4" fill="#dbeafe"/>
    <text x="95" y="145" text-anchor="middle" font-family="system-ui" font-size="10" fill="#1e40af">Browser Tab 1</text>

    <rect x="45" y="165" width="100" height="30" rx="4" fill="#dbeafe"/>
    <text x="95" y="185" text-anchor="middle" font-family="system-ui" font-size="10" fill="#1e40af">Browser Tab 2</text>

    <rect x="45" y="205" width="100" height="30" rx="4" fill="#dcfce7"/>
    <text x="95" y="225" text-anchor="middle" font-family="system-ui" font-size="10" fill="#166534">Mobile App</text>
  </g>

  <!-- WebSocket Connection Lines -->
  <path d="M 160 140 C 200 140, 200 170, 240 170" stroke="#10b981" stroke-width="2" fill="none" stroke-dasharray="5,3"/>
  <path d="M 160 180 L 240 180" stroke="#10b981" stroke-width="2" stroke-dasharray="5,3"/>
  <path d="M 160 220 C 200 220, 200 190, 240 190" stroke="#10b981" stroke-width="2" fill="none" stroke-dasharray="5,3"/>
  <text x="200" y="155" text-anchor="middle" font-family="system-ui" font-size="9" fill="#10b981">WS</text>

  <!-- Server -->
  <g filter="url(#shadow2)">
    <rect x="240" y="70" width="320" height="200" rx="10" fill="white" stroke="#e2e8f0" stroke-width="2"/>
    <rect x="240" y="70" width="320" height="35" rx="10" fill="url(#wsGrad)"/>
    <text x="400" y="93" text-anchor="middle" font-family="system-ui" font-size="12" font-weight="600" fill="white">Elysia WebSocket Server</text>
  </g>

  <!-- Connection Pool -->
  <rect x="260" y="120" width="130" height="60" rx="6" fill="#fef3c7" stroke="#f59e0b"/>
  <text x="325" y="140" text-anchor="middle" font-family="system-ui" font-size="10" font-weight="600" fill="#92400e">Connection Pool</text>
  <text x="325" y="155" text-anchor="middle" font-family="system-ui" font-size="9" fill="#b45309">Map&lt;userId, WS[]&gt;</text>
  <text x="325" y="170" text-anchor="middle" font-family="system-ui" font-size="9" fill="#b45309">Multi-tab support</text>

  <!-- Message Router -->
  <rect x="410" y="120" width="130" height="60" rx="6" fill="#e0e7ff" stroke="#6366f1"/>
  <text x="475" y="140" text-anchor="middle" font-family="system-ui" font-size="10" font-weight="600" fill="#4338ca">Message Router</text>
  <text x="475" y="155" text-anchor="middle" font-family="system-ui" font-size="9" fill="#6366f1">START_TEXT_TO_IMAGE</text>
  <text x="475" y="170" text-anchor="middle" font-family="system-ui" font-size="9" fill="#6366f1">RETRY_PROCESS, etc.</text>

  <!-- Task Manager -->
  <rect x="260" y="195" width="280" height="55" rx="6" fill="#dcfce7" stroke="#22c55e"/>
  <text x="400" y="215" text-anchor="middle" font-family="system-ui" font-size="10" font-weight="600" fill="#166534">ImageTaskManager</text>
  <text x="400" y="232" text-anchor="middle" font-family="system-ui" font-size="9" fill="#22c55e">notifyUser() â†’ Broadcasts to all user connections</text>

  <!-- Background Worker -->
  <g filter="url(#shadow2)">
    <rect x="600" y="110" width="170" height="160" rx="10" fill="white" stroke="#e2e8f0" stroke-width="2"/>
    <rect x="600" y="110" width="170" height="35" rx="10" fill="#7c3aed"/>
    <text x="685" y="133" text-anchor="middle" font-family="system-ui" font-size="12" font-weight="600" fill="white">Background Worker</text>

    <text x="615" y="165" font-family="system-ui" font-size="9" fill="#7c3aed">1. Call WaveSpeed API</text>
    <text x="615" y="182" font-family="system-ui" font-size="9" fill="#7c3aed">2. Poll for result</text>
    <text x="615" y="199" font-family="system-ui" font-size="9" fill="#7c3aed">3. Upload to R2</text>
    <text x="615" y="216" font-family="system-ui" font-size="9" fill="#7c3aed">4. Trigger NSFW check</text>
    <text x="615" y="233" font-family="system-ui" font-size="9" fill="#7c3aed">5. Notify via WebSocket</text>
  </g>

  <path d="M 560 180 L 598 180" stroke="#64748b" stroke-width="1.5" marker-end="url(#arrow)"/>

  <!-- Message Flow Timeline -->
  <g filter="url(#shadow2)">
    <rect x="30" y="300" width="740" height="220" rx="10" fill="white" stroke="#e2e8f0" stroke-width="2"/>
    <rect x="30" y="300" width="740" height="35" rx="10" fill="#1e293b"/>
    <text x="400" y="323" text-anchor="middle" font-family="system-ui" font-size="12" font-weight="600" fill="white">Message Flow: Image Generation</text>
  </g>

  <!-- Timeline -->
  <line x1="100" y1="360" x2="100" y2="500" stroke="#94a3b8" stroke-width="2"/>
  <text x="100" y="350" text-anchor="middle" font-family="system-ui" font-size="10" font-weight="600" fill="#475569">Client</text>

  <line x1="300" y1="360" x2="300" y2="500" stroke="#94a3b8" stroke-width="2"/>
  <text x="300" y="350" text-anchor="middle" font-family="system-ui" font-size="10" font-weight="600" fill="#475569">Server</text>

  <line x1="500" y1="360" x2="500" y2="500" stroke="#94a3b8" stroke-width="2"/>
  <text x="500" y="350" text-anchor="middle" font-family="system-ui" font-size="10" font-weight="600" fill="#475569">Worker</text>

  <line x1="680" y1="360" x2="680" y2="500" stroke="#94a3b8" stroke-width="2"/>
  <text x="680" y="350" text-anchor="middle" font-family="system-ui" font-size="10" font-weight="600" fill="#475569">WaveSpeed</text>

  <!-- Messages -->
  <path d="M 102 370 L 298 370" stroke="#3b82f6" stroke-width="1.5" marker-end="url(#arrow)"/>
  <text x="200" y="365" text-anchor="middle" font-family="system-ui" font-size="8" fill="#3b82f6">START_TEXT_TO_IMAGE</text>

  <path d="M 298 390 L 102 390" stroke="#10b981" stroke-width="1.5" marker-end="url(#arrowGreen)"/>
  <text x="200" y="385" text-anchor="middle" font-family="system-ui" font-size="8" fill="#10b981">CREDITS_UPDATE</text>

  <path d="M 298 410 L 102 410" stroke="#10b981" stroke-width="1.5" marker-end="url(#arrowGreen)"/>
  <text x="200" y="405" text-anchor="middle" font-family="system-ui" font-size="8" fill="#10b981">PROCESS_UPDATE (PENDING)</text>

  <path d="M 302 425 L 498 425" stroke="#7c3aed" stroke-width="1.5" marker-end="url(#arrow)"/>
  <text x="400" y="420" text-anchor="middle" font-family="system-ui" font-size="8" fill="#7c3aed">Fire-and-forget async</text>

  <path d="M 502 440 L 678 440" stroke="#64748b" stroke-width="1.5" marker-end="url(#arrow)"/>
  <text x="590" y="435" text-anchor="middle" font-family="system-ui" font-size="8" fill="#64748b">API Request</text>

  <path d="M 678 455 L 502 455" stroke="#64748b" stroke-width="1.5" marker-end="url(#arrow)"/>
  <text x="590" y="450" text-anchor="middle" font-family="system-ui" font-size="8" fill="#64748b">Image URL</text>

  <path d="M 498 470 L 298 470" stroke="#7c3aed" stroke-width="1.5"/>
  <path d="M 298 470 L 102 470" stroke="#10b981" stroke-width="1.5" marker-end="url(#arrowGreen)"/>
  <text x="200" y="465" text-anchor="middle" font-family="system-ui" font-size="8" fill="#10b981">PROCESS_UPDATE (COMPLETED)</text>

  <path d="M 298 490 L 102 490" stroke="#ef4444" stroke-width="1.5" marker-end="url(#arrow)"/>
  <text x="200" y="485" text-anchor="middle" font-family="system-ui" font-size="8" fill="#ef4444">IMAGE_BLOCKED (if NSFW)</text>
</svg>
