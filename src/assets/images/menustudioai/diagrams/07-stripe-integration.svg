<svg viewBox="0 0 800 650" xmlns="http://www.w3.org/2000/svg">
  <defs>
    <linearGradient id="stripeGrad" x1="0%" y1="0%" x2="100%" y2="0%">
      <stop offset="0%" style="stop-color:#635bff"/>
      <stop offset="100%" style="stop-color:#7a73ff"/>
    </linearGradient>
    <linearGradient id="ecbGrad" x1="0%" y1="0%" x2="100%" y2="0%">
      <stop offset="0%" style="stop-color:#003399"/>
      <stop offset="100%" style="stop-color:#0055cc"/>
    </linearGradient>
    <filter id="shadow7" x="-20%" y="-20%" width="140%" height="140%">
      <feDropShadow dx="2" dy="2" stdDeviation="3" flood-opacity="0.15"/>
    </filter>
    <marker id="arr7" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#64748b"/>
    </marker>
  </defs>

  <rect width="800" height="650" fill="#f1f5f9"/>
  <text x="400" y="35" text-anchor="middle" font-family="system-ui" font-size="20" font-weight="bold" fill="#1e293b">Stripe Multi-Currency Payment Flow</text>

  <!-- User Request -->
  <g filter="url(#shadow7)">
    <rect x="30" y="60" width="160" height="80" rx="10" fill="white" stroke="#e2e8f0" stroke-width="2"/>
    <rect x="30" y="60" width="160" height="30" rx="10" fill="#3b82f6"/>
    <text x="110" y="80" text-anchor="middle" font-family="system-ui" font-size="11" font-weight="600" fill="white">1. User Request</text>
    <text x="110" y="105" text-anchor="middle" font-family="system-ui" font-size="9" fill="#64748b">Amount: $10 USD</text>
    <text x="110" y="120" text-anchor="middle" font-family="system-ui" font-size="9" fill="#64748b">Locale: 'ja' (Japanese)</text>
  </g>

  <!-- Currency Detection -->
  <g filter="url(#shadow7)">
    <rect x="220" y="60" width="160" height="80" rx="10" fill="white" stroke="#e2e8f0" stroke-width="2"/>
    <rect x="220" y="60" width="160" height="30" rx="10" fill="#f59e0b"/>
    <text x="300" y="80" text-anchor="middle" font-family="system-ui" font-size="11" font-weight="600" fill="white">2. Currency Detect</text>
    <text x="300" y="105" text-anchor="middle" font-family="system-ui" font-size="9" fill="#64748b">'ja' → JPY (¥)</text>
    <text x="300" y="120" text-anchor="middle" font-family="system-ui" font-size="9" fill="#64748b">Zero-decimal: true</text>
  </g>

  <!-- Exchange Rate -->
  <g filter="url(#shadow7)">
    <rect x="410" y="60" width="160" height="80" rx="10" fill="white" stroke="#e2e8f0" stroke-width="2"/>
    <rect x="410" y="60" width="160" height="30" rx="10" fill="url(#ecbGrad)"/>
    <text x="490" y="80" text-anchor="middle" font-family="system-ui" font-size="11" font-weight="600" fill="white">3. ECB Rate</text>
    <text x="490" y="105" text-anchor="middle" font-family="system-ui" font-size="9" fill="#64748b">USD→JPY: 151.0</text>
    <text x="490" y="120" text-anchor="middle" font-family="system-ui" font-size="9" fill="#64748b">24h cache</text>
  </g>

  <!-- Calculate -->
  <g filter="url(#shadow7)">
    <rect x="600" y="60" width="170" height="80" rx="10" fill="white" stroke="#e2e8f0" stroke-width="2"/>
    <rect x="600" y="60" width="170" height="30" rx="10" fill="#22c55e"/>
    <text x="685" y="80" text-anchor="middle" font-family="system-ui" font-size="11" font-weight="600" fill="white">4. Calculate</text>
    <text x="685" y="105" text-anchor="middle" font-family="system-ui" font-size="9" fill="#64748b">$10 × 151 = ¥1,510</text>
    <text x="685" y="120" text-anchor="middle" font-family="system-ui" font-size="9" fill="#64748b">200 credits (from USD)</text>
  </g>

  <!-- Arrows Row 1 -->
  <path d="M 190 100 L 218 100" stroke="#64748b" stroke-width="1.5" marker-end="url(#arr7)"/>
  <path d="M 380 100 L 408 100" stroke="#64748b" stroke-width="1.5" marker-end="url(#arr7)"/>
  <path d="M 570 100 L 598 100" stroke="#64748b" stroke-width="1.5" marker-end="url(#arr7)"/>

  <!-- Stripe Checkout -->
  <g filter="url(#shadow7)">
    <rect x="30" y="170" width="360" height="180" rx="10" fill="white" stroke="#e2e8f0" stroke-width="2"/>
    <rect x="30" y="170" width="360" height="35" rx="10" fill="url(#stripeGrad)"/>
    <text x="210" y="193" text-anchor="middle" font-family="system-ui" font-size="13" font-weight="600" fill="white">5. Stripe Checkout Session</text>
  </g>

  <g font-family="monospace" font-size="9">
    <text x="50" y="225" fill="#635bff">stripe.checkout.sessions.create({</text>
    <text x="60" y="242" fill="#64748b">currency: 'jpy',</text>
    <text x="60" y="257" fill="#64748b">unit_amount: 1510,  // No ×100 for JPY</text>
    <text x="60" y="272" fill="#64748b">metadata: {</text>
    <text x="70" y="287" fill="#64748b">userId, amountUsd: '10',</text>
    <text x="70" y="302" fill="#64748b">amountLocal: '1510', currency: 'JPY',</text>
    <text x="70" y="317" fill="#64748b">exchangeRate: '151.0', credits: '200'</text>
    <text x="60" y="332" fill="#64748b">}</text>
    <text x="50" y="347" fill="#635bff">})</text>
  </g>

  <!-- Webhook Handler -->
  <g filter="url(#shadow7)">
    <rect x="420" y="170" width="350" height="180" rx="10" fill="white" stroke="#e2e8f0" stroke-width="2"/>
    <rect x="420" y="170" width="350" height="35" rx="10" fill="#dc2626"/>
    <text x="595" y="193" text-anchor="middle" font-family="system-ui" font-size="13" font-weight="600" fill="white">6. Webhook Handler (Idempotent)</text>
  </g>

  <g font-family="system-ui" font-size="10">
    <rect x="435" y="220" width="320" height="22" rx="4" fill="#fee2e2"/>
    <text x="445" y="235" fill="#991b1b">1. Verify stripe-signature header</text>

    <rect x="435" y="250" width="320" height="22" rx="4" fill="#fef3c7"/>
    <text x="445" y="265" fill="#92400e">2. Check if stripeSessionId exists (skip if yes)</text>

    <rect x="435" y="280" width="320" height="22" rx="4" fill="#dcfce7"/>
    <text x="445" y="295" fill="#166534">3. Atomic: Add credits + Create transaction</text>

    <rect x="435" y="310" width="320" height="22" rx="4" fill="#dbeafe"/>
    <text x="445" y="325" fill="#1e40af">4. WebSocket: Notify client of credit update</text>
  </g>

  <!-- Arbitrage Prevention -->
  <g filter="url(#shadow7)">
    <rect x="30" y="380" width="360" height="130" rx="10" fill="white" stroke="#e2e8f0" stroke-width="2"/>
    <rect x="30" y="380" width="360" height="30" rx="10" fill="#ef4444"/>
    <text x="210" y="400" text-anchor="middle" font-family="system-ui" font-size="12" font-weight="600" fill="white">Arbitrage Prevention (CRITICAL)</text>
  </g>

  <g font-family="system-ui" font-size="10">
    <rect x="45" y="425" width="330" height="20" rx="4" fill="#fee2e2"/>
    <text x="55" y="439" fill="#991b1b">Credits ALWAYS calculated from USD amount</text>

    <text x="55" y="465" fill="#64748b" font-family="monospace" font-size="9">const credits = calculateCreditsFromUSD(amountUsd);</text>
    <text x="55" y="485" fill="#64748b" font-family="monospace" font-size="9">// NOT from amountLocal (user sees) </text>
    <text x="55" y="500" fill="#64748b" font-family="monospace" font-size="9">// Prevents exchange rate exploit</text>
  </g>

  <!-- Transaction Record -->
  <g filter="url(#shadow7)">
    <rect x="420" y="380" width="350" height="130" rx="10" fill="white" stroke="#e2e8f0" stroke-width="2"/>
    <rect x="420" y="380" width="350" height="30" rx="10" fill="#6366f1"/>
    <text x="595" y="400" text-anchor="middle" font-family="system-ui" font-size="12" font-weight="600" fill="white">Transaction Record (Audit Trail)</text>
  </g>

  <g font-family="monospace" font-size="9">
    <text x="435" y="430" fill="#64748b">amount: 10,          // USD (for credits)</text>
    <text x="435" y="448" fill="#64748b">amountLocal: 1510,   // What user paid</text>
    <text x="435" y="466" fill="#64748b">currency: 'JPY',</text>
    <text x="435" y="484" fill="#64748b">exchangeRate: 151.0,</text>
    <text x="435" y="502" fill="#64748b">stripeSessionId: 'cs_...'  // Unique key</text>
  </g>

  <!-- Zero Decimal Currencies -->
  <g filter="url(#shadow7)">
    <rect x="30" y="540" width="360" height="90" rx="10" fill="white" stroke="#e2e8f0" stroke-width="2"/>
    <rect x="30" y="540" width="360" height="25" rx="10" fill="#7c3aed"/>
    <text x="210" y="557" text-anchor="middle" font-family="system-ui" font-size="10" font-weight="600" fill="white">Zero-Decimal Currency Handling</text>
  </g>

  <g font-family="system-ui" font-size="9">
    <text x="50" y="580" fill="#64748b">JPY ¥1510 → unit_amount: 1510 (no ×100)</text>
    <text x="50" y="598" fill="#64748b">EUR €9.20 → unit_amount: 920  (×100)</text>
    <text x="50" y="616" fill="#64748b">KRW, VND, TWD also zero-decimal</text>
  </g>

  <!-- ECB Cache Strategy -->
  <g filter="url(#shadow7)">
    <rect x="420" y="540" width="350" height="90" rx="10" fill="white" stroke="#e2e8f0" stroke-width="2"/>
    <rect x="420" y="540" width="350" height="25" rx="10" fill="url(#ecbGrad)"/>
    <text x="595" y="557" text-anchor="middle" font-family="system-ui" font-size="10" font-weight="600" fill="white">ECB Rate Cache Strategy</text>
  </g>

  <g font-family="system-ui" font-size="9">
    <text x="435" y="580" fill="#64748b">Layer 1: Memory cache (24h TTL)</text>
    <text x="435" y="598" fill="#64748b">Layer 2: ECB API (daily update)</text>
    <text x="435" y="616" fill="#64748b">Layer 3: Static fallback rates</text>
  </g>

  <!-- Arrow from checkout to webhook -->
  <path d="M 390 260 L 418 260" stroke="#635bff" stroke-width="2" marker-end="url(#arr7)"/>
  <text x="404" y="250" text-anchor="middle" font-family="system-ui" font-size="8" fill="#635bff">POST</text>
</svg>
